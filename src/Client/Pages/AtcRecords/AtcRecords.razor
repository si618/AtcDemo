@page "/atcRecords"
@using AtcDemo.Client.Data
@using AtcDemo.Shared
@using Microsoft.EntityFrameworkCore
@using QuickGrid
@inject DataSynchronizer DataSynchronizer
@implements IDisposable
@*@attribute [Authorize]*@
<PageTitle>ATC Records</PageTitle>
<SyncStatus />
<AtcDetails Record="selectedAtcRecord" OnHide="@(() => { selectedAtcRecord = null; })" />

@if (db is not null)
{
    <div class="records-grid">
        <Grid Virtualize="true" Items="@GetFilteredAtcRecords()" ItemKey="@(x => x.Code)" ItemSize="35">

            <TemplateColumn Title="Code" SortBy="@(items => items.SortByAscending(x => x.Code))" Class="col-code">
                <ChildContent>
                    @context.Level1AnatomicalMainGroup /
                    @context.Level2TherapeuticSubgroup /
                    @context.Level3PharmacologicalSubgroup /
                    @context.Level4ChemicalSubgroup /
                    @context.Level5ChemicalSubstance /
                </ChildContent>
                <ColumnOptions>
                    <p>Level 1 Anatomical Main Group (@level1.Length)</p>
                    <select multiple class="w-64 bg-gray-100 border-grey-500 border my-4" @bind="level1" @onclick="@(() =>
                        {
                            level2 = Array.Empty<string>();
                            level3 = Array.Empty<string>();
                            level4 = Array.Empty<string>();
                            level5 = Array.Empty<string>();
                        })">
                        @foreach (var name in db.Chemicals.Select(x => x.Level1AnatomicalMainGroup).Distinct())
                        {
                            <option>@name</option>
                        }
                    </select>
                    <p>Level 2 Therapeutic Subgroup (@level2.Length)</p>
                    <select multiple class="w-64 bg-gray-100 border-grey-500 border my-4" @bind="level2" @onclick="@(() =>
                        {
                            level3 = Array.Empty<string>();
                            level4 = Array.Empty<string>();
                            level5 = Array.Empty<string>();
                        })">
                        @foreach (var name in db.Chemicals.Select(x => x.Level2TherapeuticSubgroup).Distinct())
                        {
                            <option>@name</option>
                        }
                    </select>
                    <p>Level 3 Pharmacological Subgroup (@level3.Length)</p>
                    <select multiple class="w-64 bg-gray-100 border-grey-500 border my-4" @bind="level3" @onclick="@(() =>
                        {
                            level4 = Array.Empty<string>();
                            level5 = Array.Empty<string>();
                        })">
                        @foreach (var name in db.Chemicals.Select(x => x.Level3PharmacologicalSubgroup).Distinct())
                        {
                            <option>@name</option>
                        }
                    </select>
                    <p>Level 4 Chemical Subgroup (@level4.Length)</p>
                    <select multiple class="w-64 bg-gray-100 border-grey-500 border my-4" @bind="level4" @onclick="@(() =>
                        {
                            level5 = Array.Empty<string>();
                        })">
                        @foreach (var name in db.Chemicals.Select(x => x.Level4ChemicalSubgroup).Distinct())
                        {
                            <option>@name</option>
                        }
                    </select>
                    <p>Level 5 Chemical Substance (@level5.Length)</p>
                    <select multiple class="w-64 bg-gray-100 border-grey-500 border my-4" @bind="level5">
                        @foreach (var name in db.Chemicals.Select(x => x.Level5ChemicalSubstance).Distinct())
                        {
                            <option>@name</option>
                        }
                    </select>
                    <div><button class="bg-gray-200 px-5 py-1 mb-2" @onclick="@(() =>
                        {
                            level1 = Array.Empty<string>();
                            level2 = Array.Empty<string>();
                            level3 = Array.Empty<string>();
                            level4 = Array.Empty<string>();
                            level5 = Array.Empty<string>();
                        })">Reset</button></div>
                </ColumnOptions>
            </TemplateColumn>

            <PropertyColumn Title="Name" Property="@(x => x.Name)" Class="col-name"
                OnCellClicked="@((AtcChemical record) => { selectedAtcRecord = record; })">
                <ColumnOptions>
                    <input @bind="searchName" @bind:event="oninput" type="search" placeholder="Search..." />
                </ColumnOptions>
            </PropertyColumn>

@*            <Grid class="ddd-grid" Virtualize="false" Items="@(x => x.D)" ItemKey="@(x => x.Code)" ItemSize="35">

            </Grid>

            <PropertyColumn Title="Stock" Property="@(x => x.Stock)" Format="N0" Align="Align.Right" Class="col-stock">
                <ColumnOptions>
                    <p>Min stock</p>
                    <input type="range" @bind="minStock" @bind:event="oninput" min="0" max="50000" />
                    <p>Max stock</p>
                    <input type="range" @bind="maxStock" @bind:event="oninput" min="0" max="50000" />
                </ColumnOptions>
            </PropertyColumn>

            <PropertyColumn Title="Administration Route" Property="@(x => x.PriceCents/100)" Class="col-route" />
*@
        </Grid>
        <div class="status-bar">
            Showing @GetFilteredAtcRecords()?.Count().ToString("N0") items
        </div>
    </div>
}

@code {
    AtcClientDbContext? db;

    [Parameter] public string? SearchName { get; set; }

    string[] administrationRoute = Array.Empty<string>();
    string[] level1 = Array.Empty<string>();
    string[] level2 = Array.Empty<string>();
    string[] level3 = Array.Empty<string>();
    string[] level4 = Array.Empty<string>();
    string[] level5 = Array.Empty<string>();
    string searchName = string.Empty;
    int minDose = 0, maxDose = 10000;
    AtcChemical? selectedAtcRecord;

    IQueryable<AtcChemical>? GetFilteredAtcRecords()
    {
        if (db is null)
        {
            return null;
        }

        var result = db.Chemicals.AsNoTracking().AsQueryable();
        if (!string.IsNullOrEmpty(searchName))
        {
            result = result.Where(x => EF.Functions.Like(x.Name, searchName.Replace("%", "\\%") + "%", "\\"));
        }
        if (level1.Any())
        {
            result = result.Where(x => level1.Contains(x.Level1AnatomicalMainGroup));
        }
        if (level2.Any())
        {
            result = result.Where(x => level2.Contains(x.Level2TherapeuticSubgroup));
        }
        if (level3.Any())
        {
            result = result.Where(x => level3.Contains(x.Level3PharmacologicalSubgroup));
        }
        if (level4.Any())
        {
            result = result.Where(x => level4.Contains(x.Level4ChemicalSubgroup));
        }
        if (level5.Any())
        {
            result = result.Where(x => level5.Contains(x.Level5ChemicalSubstance));
        }
        if (minDose > 0)
        {
            result = result.Where(x => x.Doses.Any(d => d.DefinedDailyDose >= minDose));
        }
        if (maxDose > 0)
        {
            result = result.Where(x => x.Doses.Any(d => d.DefinedDailyDose <= maxDose));
        }
        if (administrationRoute.Any())
        {
            result = result.Where(x => x.Doses.Any(d => administrationRoute.Contains(d.AdministrationRoute)));
        }

        return result;
    }

    protected override async Task OnInitializedAsync()
    {
        db = await DataSynchronizer.GetPreparedDbContextAsync();
        DataSynchronizer.OnUpdate += StateHasChanged;
    }

    protected override void OnParametersSet()
    {
        searchName = SearchName ?? string.Empty;
    }

    public void Dispose()
    {
        db?.Dispose();
        DataSynchronizer.OnUpdate -= StateHasChanged;
    }
}
